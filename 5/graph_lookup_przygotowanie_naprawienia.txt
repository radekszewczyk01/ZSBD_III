var targetAuthor = "Joachim Boldt";

db.collaborations.aggregate([
  // 1. Startujemy od Boldta
  { $match: { author: targetAuthor } },
  
  // 2. Szukamy w grafie (tak jak wcześniej)
  {
    $graphLookup: {
      from: "collaborations",
      startWith: "$_id", // Uwaga: w poprzednim kroku nie grupowałem, więc to może być mylące
      // Żeby było czyściej, najlepiej startować od UNIKALNEGO autora.
      // Zróbmy mały trik: Najpierw zgrupujmy start.
      connectFromField: "collaborator",
      connectToField: "author",
      maxDepth: 1,
      depthField: "level",
      as: "raw_network"
    }
  },

  // --- POPRAWKA: DEDUPLIKACJA ---
  
  // 3. Rozbijamy sieć na pojedyncze elementy
  { $unwind: "$raw_network" },

  // 4. Grupujemy, żeby usunąć duplikaty (np. 50 artykułów z Hempelmannem -> 1 Hempelmann)
  {
    $group: {
      _id: "$raw_network.collaborator", // Grupuj po nazwisku wspólnika
      distance: { $min: "$raw_network.level" }, // Zachowaj najkrótszy dystans (0 = bezpośredni)
      collaboration_count: { $sum: 1 } // Przy okazji policz, ile razy współpracowali!
    }
  },

  // 5. Odrzuć samego siebie (Boldta) z wyników
  { $match: { _id: { $ne: targetAuthor } } },

  // 6. Sortuj: najpierw bezpośredni współpracownicy (dystans 0), potem najczęstsi
  { $sort: { distance: 1, collaboration_count: -1 } },

  // 7. Pokaż Top 20
  { $limit: 20 },

  // 8. Ładny wynik
  {
    $project: {
      Collaborator: "$_id",
      Distance: "$distance", // 0 = Bezpośredni, 1 = "Znajomy znajomego"
      "Shared Articles (in graph path)": "$collaboration_count"
    }
  }
])