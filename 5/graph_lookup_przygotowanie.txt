print("â³ Budowanie grafu wspÃ³Å‚pracy (Collaborations)...");

var bulkOps = [];
var counter = 0;

// Pobieramy artykuÅ‚y, ktÃ³re majÄ… wiÄ™cej niÅ¼ 1 autora (bo tam jest wspÃ³Å‚praca)
// UÅ¼ywamy pola tekstowego Author (dzielonego Å›rednikami) bo jest najpewniejsze
db.articles.find({ Author: /;/ }).forEach(doc => {
    if (doc.Author) {
        // CzyÅ›cimy i dzielimy autorÃ³w
        var authors = doc.Author.split(';').map(a => a.trim()).filter(a => a.length > 0);
        
        // Generujemy pary "kaÅ¼dy z kaÅ¼dym"
        // JeÅ›li jest 3 autorÃ³w [A, B, C], to mamy pary: A-B, A-C, B-A, B-C, C-A, C-B
        for (var i = 0; i < authors.length; i++) {
            for (var j = 0; j < authors.length; j++) {
                if (i === j) continue; // Nie Å‚Ä…czymy autora z samym sobÄ…

                bulkOps.push({
                    insertOne: {
                        document: {
                            author: authors[i],
                            collaborator: authors[j],
                            article_id: doc._id // Dajemy ID artykuÅ‚u jako dowÃ³d wspÃ³Å‚pracy
                        }
                    }
                });
            }
        }
    }

    // Zapisujemy paczkami po 2000 (grafy rosnÄ… szybko!)
    if (bulkOps.length >= 2000) {
        db.collaborations.bulkWrite(bulkOps);
        bulkOps = [];
        counter++;
        if (counter % 50 === 0) print("Przetworzono paczkÄ™ nr " + counter);
    }
});

if (bulkOps.length > 0) db.collaborations.bulkWrite(bulkOps);

print("âœ… Graf zbudowany! TworzÄ™ indeksy...");
db.collaborations.createIndex({ author: 1 });
db.collaborations.createIndex({ collaborator: 1 });
print("ğŸ‰ Gotowe. Masz teraz sieÄ‡ spoÅ‚ecznoÅ›ciowÄ… naukowcÃ³w.");