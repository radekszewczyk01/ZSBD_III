db.authors_authenticated.aggregate([
    // 1. Weź autorów, którzy mają ocenę ryzyka i przypisaną instytucję
    { 
        $match: { 
            personal_risk_score: { $exists: true },
            institution_ids: { $exists: true, $ne: [] } 
        } 
    },

    // 2. Rozbij instytucje (Autor X należy do Instytucji A i B -> liczymy go tu i tu)
    { $unwind: "$institution_ids" },

    // 3. Zgrupuj po ID Instytucji
    { 
        $group: {
            _id: "$institution_ids",
            avg_institution_score: { $avg: "$personal_risk_score" }, // Średnia z oceny autorów
            bad_authors_count: { $sum: 1 } // Ilu "podejrzanych" autorów tu pracuje
        }
    },

    // 4. Dołącz nazwę instytucji (Szybki lookup po ID)
    {
        $lookup: {
            from: "institutions",
            localField: "_id",
            foreignField: "_id",
            as: "info"
        }
    },

    // 5. Filtr: Pokaż tylko te, gdzie złapano min. 3 autorów (eliminacja błędu statystycznego)
    { $match: { bad_authors_count: { $gte: 3 } } },

    // 6. Sortuj od najgorszej uczelni
    { $sort: { avg_institution_score: -1 } },
    { $limit: 10 },

    // 7. Ładny wynik
    {
        $project: {
            Institution: { $arrayElemAt: ["$info.name", 0] },
            "Risk Score": { $round: ["$avg_institution_score", 2] },
            "Authors Count": "$bad_authors_count"
        }
    }
])